#!/usr/bin/env python3
from piper_sdk import C_PiperInterface
import math
import time

# === 0. ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°é–¢æ•° ===
def deg_to_piper(angle_deg: float) -> int:
    """è§’åº¦[deg]ã‚’Piperã®å†…éƒ¨å˜ä½(0.001åº¦)ã«å¤‰æ›"""
    return int(angle_deg * 1000)

def rad_to_piper(angle_rad: float) -> int:
    """è§’åº¦[rad]ã‚’Piperã®å†…éƒ¨å˜ä½(0.001åº¦)ã«å¤‰æ›"""
    return int(angle_rad * 180.0 / math.pi * 1000)

# === 1. æ¥ç¶š ===
arm = C_PiperInterface(can_name='can1')
arm.ConnectPort()
print("âœ… Connected to Piper on can1")

# === 2. ãƒˆãƒ«ã‚¯ON ===
arm.EnableArm(7)
time.sleep(0.5)  # â† ãƒˆãƒ«ã‚¯ONãŒå®‰å®šã™ã‚‹ã¾ã§å°‘ã—å¾…ã¤
print("âœ… Arm enabled")

# çŠ¶æ…‹ç¢ºèªï¼ˆTrueãŒä¸¦ã‚“ã§ã„ã‚Œã°OKï¼‰
print("Enable status:", arm.GetArmEnableStatus())

# === 3. ãƒ¢ãƒ¼ãƒ‰è¨­å®šï¼ˆä½ç½®åˆ¶å¾¡ãƒ¢ãƒ¼ãƒ‰ï¼‰ ===
arm.ModeCtrl(ctrl_mode=0x01, move_mode=0x01, move_spd_rate_ctrl=80)
time.sleep(0.2)  # â† ã“ã“é‡è¦ã€è¨­å®šåæ˜ å¾…ã¡
print("âœ… Mode set to position control (speed=80)")

# === 4. é©å½“ãªä½ç½®ã«å‹•ã‹ã™ ===
# å®‰å…¨ãªè§’åº¦ï¼šÂ±0.5rad â‰’ Â±28.6Â°
target_joints = [
    0,
    -int(0.2 * 180 / math.pi * 1000),  # -0.2rad
    int(0.7 * 180 / math.pi * 1000),   # 0.7rad
    0,
    0,
    0
]


print(f"ğŸ¦¾ Moving to: {target_joints}")
arm.JointCtrl(*target_joints)

# === 5. ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª ===
time.sleep(0.5)
status = arm.GetArmStatus().arm_status.motion_status
print("motion_status:", status)  # 1 = å®Ÿè¡Œä¸­, 0 = åœæ­¢ä¸­

# === 6. æ•°ç§’å¾…ã£ã¦å®Œäº† ===
time.sleep(3)
print("âœ… Done.")
